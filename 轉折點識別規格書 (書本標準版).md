# 轉折點識別規格書 (書本標準版)

## 文檔版本
- **版本號**: v2.0
- **更新日期**: 2025-10-23
- **規格來源**: 書本原始規格 + 實務需求整合

---

## 1. 功能概述

### 1.1 目的
根據書本規格,以 **5日移動平均線(MA5)** 為依據,識別股價的**轉折高點**和**轉折低點**,形成**轉折波**。

### 1.2 核心概念
- **正價群組**: 收盤價在MA5上方的K線群組 (在該均線期間內買進都賺錢)
- **負價群組**: 收盤價在MA5下方的K線群組 (在該均線期間內買進都賠錢)
- **轉折高點**: 當股價收盤往下跌破MA5時,取**均線上方正價群組的最高點**(含上影線)
- **轉折低點**: 當股價收盤往上突破MA5時,取**均線下方負價群組的最低點**(含下影線)
- **轉折波**: 依序由左至右,將取到的高低點連接起來形成的折線

---

## 2. 書本原始規格

### 2.1 轉折波畫法 (書本規則)

#### 規則1: 依據5日均線
以5日均線為依據來畫轉折波(5日均線是股價最近5天收盤價的平均值移動曲線)。

#### 規則2: 正價與負價定義
- 以收盤價來看,股價在均線上方的K線,一律看做**正價**(在該均線期間內買進都賺錢)
- 股價在均線下方的K線,一律看做**負價**(在該均線期間內買進都賠錢)

#### 規則3: 向下跌破時取最高點
當股價收盤往下跌破均線時,取**均線上方正價群組的最高點**(含上影線)

#### 規則4: 向上突破時取最低點
當股價收盤往上突破均線時,取**均線下方負價群組的最低點**(含下影線)

#### 規則5: 連接成轉折波
依序由左至右,將取到的高低點連接起來,即完成轉折波。

#### 規則6: 重要原則

**(1) 不可遺漏最高點及最低點**
- 必須捕捉每個正價群組的最高點和每個負價群組的最低點

**(2) 位移規則 ⭐ 核心規則**
```
在下個點產生前,如果所取的高低點右邊有更高或更低的點,
該高低點要往上或往下位移。
```

**具體說明**:
- 當標記一個**轉折低點**後,如果在下一個**向上穿越MA5**發生前,負價群組中又出現了**更低的點**,則需要將原本的轉折低點**位移**到新的更低點位置
- 當標記一個**轉折高點**後,如果在下一個**向下穿越MA5**發生前,正價群組中又出現了**更高的點**,則需要將原本的轉折高點**位移**到新的更高點位置

**位移範例**:
```
情境: 向上穿越MA5後標記轉折低點
時間軸: T0 T1 T2 T3 T4 T5 T6 T7
        ↓        ↓     ↓
        穿越     低點1  低點2(更低)

步驟:
1. T1: 向上穿越MA5,在負價群組中標記T2為轉折低點
2. T5: 發現T5的低點比T2更低
3. 位移: 取消T2的標記,改標記T5為轉折低點
4. T6: 再次向上確認穿越,T5成為最終轉折低點
```

**(3) 高低點交互選取**
取完高點接著取低點,必須交替出現,不可連續出現兩個高點或兩個低點。

---

## 3. 算法實作規格

### 3.1 輸入數據要求

#### 必要欄位
- **index**: 時間索引 (DatetimeIndex格式)
- **Close**: 收盤價 (浮點數)
- **High**: 最高價,含上影線 (浮點數)
- **Low**: 最低價,含下影線 (浮點數)
- **ma5**: 5日移動平均線 (浮點數)

### 3.2 輸出格式

結果為DataFrame,包含以下欄位:
- **date**: 日期 (字串格式 'YYYY-MM-DD')
- **turning_high_point**: 轉折高點標記 ('O' 表示是轉折高點, 空字串表示不是)
- **turning_low_point**: 轉折低點標記 ('O' 表示是轉折低點, 空字串表示不是)

### 3.3 核心算法流程

#### 階段1: 穿越檢測 (Cross Detection)

**目的**: 識別收盤價與MA5的穿越事件

**穿越定義**:
- **向上穿越**: 收盤價從MA5下方穿越到MA5上方
- **向下穿越**: 收盤價從MA5上方穿越到MA5下方

**實作細節 - 連續2天確認機制** (降低假信號):

**向上穿越確認條件**:
- 前2天: 收盤價在MA5下方或等於MA5
- 前1天: 收盤價站上MA5
- 當天: 收盤價持續站上MA5

**向下穿越確認條件**:
- 前2天: 收盤價在MA5上方或等於MA5
- 前1天: 收盤價跌破MA5
- 當天: 收盤價持續跌破MA5

**需要追蹤的狀態變量**:
- **last_cross_up_idx**: 上次向上穿越的索引位置
- **last_cross_down_idx**: 上次向下穿越的索引位置
- **last_marked_type**: 上次標記的類型 ('high' 或 'low')
- **last_marked_date**: 上次標記的日期

#### 階段2: 群組極值識別 (Group Extremum Identification)

**向上穿越 → 標記轉折低點**

**觸發時機**: 檢測到向上穿越事件

**處理邏輯**:

1. **定義負價群組區間**:
   - 起點 = 上次向下穿越位置 (last_cross_down_idx)
   - 終點 = 當前向上穿越位置

2. **在負價群組中尋找最低價**:
   - 找出該區間內Low欄位的最小值
   - 記錄最小值對應的日期

3. **檢查交替原則**:
   - 如果上次標記的不是低點 (確保不連續標記低點)
   - 則在找到的最低點日期標記轉折低點
   - 更新 last_marked_type = 'low'
   - 更新 last_marked_date 為該日期

---

**向下穿越 → 標記轉折高點**

**觸發時機**: 檢測到向下穿越事件

**處理邏輯**:

1. **定義正價群組區間**:
   - 起點 = 上次向上穿越位置 (last_cross_up_idx)
   - 終點 = 當前向下穿越位置

2. **在正價群組中尋找最高價**:
   - 找出該區間內High欄位的最大值
   - 記錄最大值對應的日期

3. **檢查交替原則**:
   - 如果上次標記的不是高點 (確保不連續標記高點)
   - 則在找到的最高點日期標記轉折高點
   - 更新 last_marked_type = 'high'
   - 更新 last_marked_date 為該日期

#### 階段3: 位移規則實作 ⭐ 關鍵特性

**核心概念**:
書本規格的「位移規則」是**動態調整機制**,確保在下一個穿越發生前,始終標記該群組中的**真正極值點**。

**位移實作方式A: 即時更新法** (推薦)

這個方法在處理每根K線時,持續追蹤當前群組的極值,如果發現更極端的值就立即更新標記位置。

**主要組件**:

1. **群組追蹤器** - 需要維護以下狀態:
   - current_group_start: 當前群組起點
   - current_group_type: 當前群組類型 ('positive' 或 'negative')
   - current_extremum_idx: 當前極值位置
   - current_extremum_value: 當前極值數值
   - pending_marks: 待確認的標記字典

2. **穿越時的更新邏輯**:
   
   **當發生向上穿越時**:
   - 如果當前正在負價群組中,則確認並標記該群組的最低點
   - 開始新的正價群組
   - 初始化該群組的最高點為當前K線的High

   **當發生向下穿越時**:
   - 如果當前正在正價群組中,則確認並標記該群組的最高點
   - 開始新的負價群組
   - 初始化該群組的最低點為當前K線的Low

3. **群組內持續更新極值** (這就是位移的實現):
   
   **在正價群組內**:
   - 檢查每根K線的High
   - 如果當前High > 記錄的最高值
   - 則更新極值位置和數值 (這就是"位移")

   **在負價群組內**:
   - 檢查每根K線的Low
   - 如果當前Low < 記錄的最低值
   - 則更新極值位置和數值 (這就是"位移")

4. **確認標記**:
   - 當群組結束(發生穿越)時
   - 將追蹤的極值位置和類型記錄到結果中

---

**位移實作方式B: 回溯修正法**

這個方法先按基本邏輯標記轉折點,然後再回溯檢查並修正不符合位移規則的標記。

**修正流程**:

1. **初次標記**: 依照基本穿越和群組極值邏輯,完成初步的轉折點標記

2. **回溯檢查轉折低點**:
   - 遍歷所有已標記的轉折低點
   - 對每個轉折低點:
     * 找到該點到下一個向上穿越之間的區間
     * 在該區間內尋找真正的最低點
     * 如果真正最低點不是當前標記的位置
     * 則取消原標記,在新位置重新標記

3. **回溯檢查轉折高點**:
   - 遍歷所有已標記的轉折高點
   - 對每個轉折高點:
     * 找到該點到下一個向下穿越之間的區間
     * 在該區間內尋找真正的最高點
     * 如果真正最高點不是當前標記的位置
     * 則取消原標記,在新位置重新標記

4. **返回修正後的結果**

**方式A vs 方式B 比較**:
- **方式A (即時更新)**: 效率較高,邏輯清晰,一次遍歷完成
- **方式B (回溯修正)**: 容易理解,但需要多次遍歷數據

### 3.4 邊界條件處理

#### 數據起始邊界
- 前2天數據不足時,無法進行穿越確認
- 這些日期的轉折高點和轉折低點都標記為空字串

#### MA5缺失處理
- MA5需要至少5天數據才能計算
- 如果某日期的MA5值為空,該日期不進行轉折點判斷
- 轉折高點和轉折低點都標記為空字串

#### 數據末尾邊界
最後一個群組可能尚未完成穿越,需要保留待確認狀態。

有兩種處理方案:
- **方案A**: 暫不標記,等待下一個穿越確認 (較保守)
- **方案B**: 使用當前已知的極值作為臨時標記 (較激進)

### 3.5 性能優化建議

#### 向量化運算
使用pandas的向量化操作替代逐行循環,可以大幅提升性能:
- 先計算所有日期的收盤價與MA5關係
- 使用shift函數批量獲取前一天、前兩天的數據
- 使用布林運算批量識別穿越事件

#### 增量更新
對於需要實時更新的場景:
- 只處理新增的K線及其影響範圍
- 不重新計算全部歷史數據
- 保存上次計算的狀態,從斷點繼續

---

## 4. 驗證與測試

### 4.1 單元測試用例

#### 測試案例1: 基本穿越檢測

**測試數據**:
```
日期      Close   MA5    位置
Day1      100     95     (上方)
Day2      100     96     (上方)
Day3      94      97     (下方) ← 向下穿越
Day4      93      96     (下方)
```

**預期結果**: Day3 應檢測到向下穿越事件

---

#### 測試案例2: 位移規則驗證

**測試數據**:
```
日期      Close   MA5     Low     位置
Day1      100     95      99      (上方)
Day2      94      96      93      (下方) ← 初始低點
Day3      93      95      92      (下方) ← 更低點,應位移至此
Day4      96      94      95      (上方) ← 向上穿越
```

**預期結果**: 最終轉折低點應標記在 Day3 (Low=92),而非 Day2

**驗證重點**: 這個案例驗證了位移規則是否正確實作

---

#### 測試案例3: 高低點交替

**測試情境**: 連續兩次向下穿越,中間沒有向上穿越

**預期結果**: 
- 只標記第一個轉折高點
- 第二個轉折高點不標記
- 遵循交替原則

### 4.2 整合測試

#### 測試方法
使用真實股票數據進行完整流程測試:

1. 載入測試股票數據(例如: 台積電 2330)
2. 計算5日移動平均線
3. 執行轉折點識別算法
4. 驗證結果是否符合以下規則:
   - 檢查高低點是否正確交替
   - 檢查是否有遺漏的極值點
   - 檢查位移規則是否正確執行

#### 驗證項目清單
- ✓ 轉折點高低交替 (不可連續出現兩個高點或兩個低點)
- ✓ 無遺漏極值 (每個群組的真正極值都應被標記)
- ✓ 位移規則合規 (標記的點確實是該群組的最極端值)

### 4.3 視覺化驗證

**繪圖驗證方法**:

建議繪製包含以下元素的K線圖:
1. K線圖 (紅色上漲,綠色下跌)
2. MA5曲線 (藍色線)
3. 轉折高點標記 (紅色向下箭頭或三角形)
4. 轉折低點標記 (綠色向上箭頭或三角形)
5. 正價/負價群組背景色 (淺色區塊標示)

**人工檢查重點**:
- 每個轉折點是否確實對應該群組的極值
- 高低點是否正確交替
- 視覺上是否有明顯遺漏的極值點

---

## 5. 常見問題與解答

### 5.1 為什麼需要「連續2天確認」機制?

**問題**: 書本規格只提到「收盤價穿越MA5」,為何實作加入連續2天確認?

**答**: 
- 單日穿越可能是假突破或雜訊
- 連續2天確認可以過濾短期波動
- 減少假信號,提高轉折點質量
- 這是實務經驗的優化,不違背書本精神

### 5.2 位移規則為何會造成「遺漏」和「多出」?

**問題**: 為什麼兩個算法會有26個遺漏和5個多出的差異?

**答**:
- **遺漏**: 原本標記的點因為後續出現更極端的值而被位移到新位置
- **多出**: 新位移到的位置就是「多出」的日期
- 這是位移規則的正常結果,不是錯誤
- 26個遺漏 + 某些合併 = 5個新位置

**範例說明**:
```
原始標記: 2024-05-08 為轉折低點
後續發現: 2025-08-20 更低
執行位移: 取消 2024-05-08 (遺漏) → 改標記 2025-08-20 (多出)
```

### 5.3 如何判斷哪個算法正確?

**判斷方法**:
1. **視覺化驗證**: 將爭議日期在K線圖上標註,目視檢查
2. **群組完整性**: 檢查每個正價/負價群組是否標記了真正的極值
3. **書本規格對照**: 嚴格對照書本6條規則,尤其是位移規則

**關鍵指標**:
- 有實作位移規則 = 符合書本規格
- 無實作位移規則 = 不符合書本規格

### 5.4 位移規則難以實作怎麼辦?

**建議**:
- 先實作方式A (即時更新法)
- 方式A較直觀,在處理每根K線時持續追蹤極值
- 當穿越發生時才確認標記,自然符合位移規則

---

## 6. 實作檢查清單

在實作轉折點識別算法時,請確認以下項目:

### 6.1 基本功能
- [ ] 正確計算MA5
- [ ] 正確識別收盤價與MA5的位置關係
- [ ] 正確檢測向上穿越事件
- [ ] 正確檢測向下穿越事件

### 6.2 核心規則
- [ ] 規則1: 基於5日均線
- [ ] 規則2: 正確定義正價/負價群組
- [ ] 規則3: 向下跌破時取正價群組最高點 (含上影線)
- [ ] 規則4: 向上突破時取負價群組最低點 (含下影線)
- [ ] 規則5: 轉折點由左至右連接
- [ ] 規則6-1: 不可遺漏最高點及最低點
- [ ] 規則6-2: ⭐ **位移規則** (右邊出現更極端值時位移)
- [ ] 規則6-3: 高低點交互選取

### 6.3 品質檢查
- [ ] 無連續兩個高點或低點
- [ ] 每個群組的極值都被標記
- [ ] 位移規則正確執行
- [ ] 邊界條件正確處理

### 6.4 測試驗證
- [ ] 通過基本穿越檢測測試
- [ ] 通過位移規則驗證測試
- [ ] 通過高低點交替測試
- [ ] 通過真實股票數據測試
- [ ] 視覺化驗證無明顯錯誤

---

## 7. 版本歷史

### v2.0 (2025-10-23)
- 完整整合書本原始規格
- 詳細說明位移規則實作方法
- 新增常見問題解答
- 新增實作檢查清單

### v1.0 (初始版本)
- 基本轉折點識別功能
- 未實作位移規則

---

## 8. 參考資料

- 書本原始規格文件
- 轉折點識別實作程式碼: `src/baseRule/turning_point_identification.py`
- 測試程式: `test_turning_point_identification.py`
- 診斷程式: `debug_turning_point_algorithm.py`

---

**文檔結束**