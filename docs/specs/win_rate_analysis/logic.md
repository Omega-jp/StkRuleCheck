# Momentum Shift 勝率分析業務邏輯 (logic.md)

## 1. 交易生命流程 (Trade Lifecycle)

### 1.1 進場階段 (Entry Phase)
- **掃描區間**：回測數據中的所有 K 線。
- **偵測信號**：當 `ms_buy_signal` 為 `'O'` 時，標記一個新的「潛在交易」。
- **實際進場**：在信號日 $T$ 的下一個交易日 $T+1$ 以 **開盤價 (Open)** 買入。
- **部位管理**：若在前一次交易尚未結束（未清倉）前又出現新的買入信號，需決定是否加碼或忽略。
    - *預設*：一次僅持有一筆部位，若已在場內，則忽略新信號（避免重複計算勝率）。

### 1.2 持有與風控階段 (Holding & Management)
部位狀態分為兩種：**[INITIAL]** 與 **[TRENDING]**。

#### A. INITIAL 狀態 (未站上 5MA)
- **進入條件**：剛買入即進入此狀態。
- **轉場條件**：當日 `Close >= 5MA`，則狀態變更為 **[TRENDING]**。
- **出場條件**（止損）：當日 `Close < ms_level`。
- **動作**：若觸發出場，則次一交易日 $T_{exit}$ 以 **開盤價 (Open)** 全數賣出，交易結束。

#### B. TRENDING 狀態 (已站上 5MA)
- **出場條件 1** (減碼)：當日 `Close < 5MA` 且尚未減碼。
    - **動作**：次一交易日 $T_{half}$ 以 **開盤價 (Open)** 賣出 **50%**。
- **出場條件 2** (清倉)：當日 `Close < 10MA`。
    - **動作**：次一交易日 $T_{full}$ 以 **開盤價 (Open)** 賣出 **剩餘全部部位**，交易結束。

> [!IMPORTANT]
> - 一旦進入 [TRENDING] 狀態，系統將不再監控 `ms_level`。
> - 若單日收盤價同時跌破 $5MA$ 與 $10MA$，則於次日開盤 **全數賣出**。

### 1.3 結算階段 (Settlement)
一筆交易結束後（清倉），計算該筆交易的 **實現盈虧 (Realized P/L)**。
- $P/L = (\text{賣出總額} - \text{買入總額}) / \text{買入總額}$
- **勝 (Win)**：$P/L > 0$
- **負 (Loss)**：$P/L \le 0$

## 2. 統計指標 (KPIs)
- **總勝率 (Win Rate)**：$\frac{\text{獲利次數}}{\text{總交易次數}}$
- **盈虧比 (Profit/Loss Ratio)**：$\frac{\text{平均獲利 \%}}{\text{平均虧損 \%}}$
- **最大回測 (Max Drawdown)**：交易期間內部位價值的最大回落。
- **每支股票勝率**：個別統計 $stklist.cfg$ 中的股票表現。
